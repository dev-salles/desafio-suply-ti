#!/usr/bin/env bash

# Aborta o script se algum comando falhar
set -e

# Garante que estamos no diretório correto
cd /var/www/html

# Limpa caches antigos antes de qualquer coisa para garantir que o DB_CONNECTION=pgsql seja lido
echo "Limpando configurações prévias..."
/usr/bin/php8.3 artisan config:clear
/usr/bin/php8.3 artisan cache:clear

# Tenta rodar as migrations se a variável DATABASE_URL estiver presente
if [ ! -z "$DATABASE_URL" ]; then
    echo "Detectada DATABASE_URL. Configurando banco de dados PostgreSQL..."
    # O comando migrate agora deve funcionar pois o cache foi limpo acima
    /usr/bin/php8.3 artisan migrate --force
fi

echo "Gerando caches de performance..."
/usr/bin/php8.3 artisan config:cache
/usr/bin/php8.3 artisan route:cache
/usr/bin/php8.3 artisan view:cache

echo "Iniciando o Supervisor..."

# Inicia o supervisord em primeiro plano (-n)
exec /usr/bin/supervisord -n -c /etc/supervisor/conf.d/supervisord.conf